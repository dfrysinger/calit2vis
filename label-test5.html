<!DOCTYPE html>
<meta charset="utf-8">
<script src="http://d3js.org/d3.v2.min.js?2.9.3"></script>
<script type="text/javascript" src="preprocess_force.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>


<style>

svg {
  border: 1px solid #FEE;
}

.node text {
  pointer-events: none;
  font-family: sans-serif;
  stroke: #ddd;
  position: relative;
  z-index: 1001;
}

.countryKey {
  display: block;
  position: absolute;
  left: 0;
  bottom: 0;
  width: 100px;
  height: 450px;
  background: #fee;
  padding: 10px;
  font-size: 10px;
  font-family: sans-serif;
}

.country {
  display: block;
  width: 100px;
  height: 12px;
}

.countryName {
  display: block;
  float: left;
  height: 12px;
  width: 87px;
  padding: 0 0 0 3px;
}
.keyBox {
  display: block;
  float: left;
  width: 10px;
  height: 10px;
}

.metapane {
  display: none;
  position: absolute;
  right: 0;
  top: 0;
  width: 250px;
  height: 100%;
  background: #DDE;
  padding: 20px;
}
.nodename, .nodecountry, .nodedollarvalue {
  font-family: Verdana, Geneva, sans-serif;
  color: #113;
  line-height: 32px;
}
.nodename {
  font-size: 32px;
}
.nodecountry {
  font-size: 18px;
}
.nodedollarvalue {
  font-size: 18px;
}

</style>

<body>
<script>

  //From: http://stackoverflow.com/questions/149055/how-can-i-format-numbers-as-money-in-javascript
  Number.prototype.formatMoney = function(c, d, t){
    var n = this, c = isNaN(c = Math.abs(c)) ? 2 : c, d = d == undefined ? "." : d, t = t == undefined ? "," : t, s = n < 0 ? "-" : "", i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", j = (j = i.length) > 3 ? j % 3 : 0;
    return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
   };

  function log(base, val) {
    return Math.log(val) / Math.log(base);
  }

  function mapNodes(nodes) {
    var nodesMap;
    nodesMap = d3.map();
    nodes.forEach(function(n) {
      return nodesMap.set(n.key, n);
    });
    return nodesMap;
  }

  function neighboring(a, b) {
    //console.log("checking: ", a, " vs: ", b, " in: ", linkedByIndex);
    return (zoom && (a.key == zoomed.key && ((linkedByIndex[a.key + "," + b.key] || linkedByIndex[b.key + "," + a.key])) ||
                    a.key == b.key || b.key == zoomed.key)) ||
           (!zoom && (linkedByIndex[a.key + "," + b.key] || linkedByIndex[b.key + "," + a.key]));
  }

var width = 1480,
    height = 900,
    radius = 6,
    fill = d3.scale.category20(),
    linkcolordark = "#888",
    linkcolorlight = "#AAA",
    linkedByIndex = {};

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("id", "svg");

var linkGroup = svg.append("g").attr("class", "linkGroup");
var nodeGroup = svg.append("g").attr("class", "nodeGroup");

var force = d3.layout.force();

var zoom = 0;
var zoomed = null;

var links = force.links();
var nodes = force.nodes();

d3.json("IntlNodes.json", function(json) {
  json = preprocess.links(json);

  nodesMap = mapNodes(json.nodes);

  json.links.forEach(function(l) {
    l.source = nodesMap.get(l.source);
    l.target = nodesMap.get(l.target);
    return linkedByIndex["" + l.source.key + "," + l.target.key] = 1;
  });

  resetForce();

  printCountryKey();

  force.on("tick", function(e) {

    svg.selectAll(".node").attr("transform", function(d) {
      if(zoom && d == zoomed){
        var k = e.alpha * 2;
        var x = width/2;
        var y = height/2;
        d.x += (x - d.x) * k;
        d.y += (y - d.y) * k;
      }
      return "translate(" + d.x + "," + d.y + ")";
    });

    svg.selectAll(".link").attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

  });

  function click(d, i) {
    d3.event.stopPropagation();

    if(zoom){
      if(zoomed == d){
        return null;
      }
      reset();
    }

    nodes = nodes.filter(function(n) { return (neighboring(d, n) || d == n) ? this : null; });
    links = links.filter(function(l) { return (l.source == d || l.target === d) ? this : null; });

    refresh();

    d3.select(this).append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .attr("font-size", 20)
            .attr("stroke-width", 0)
            .attr("fill", "#000")
            .attr("font-weight", "900")
            .text(function(d) { return d.name });

    svg.selectAll(".node").append("text")
              .attr("dx", 12)
              .attr("dy", ".35em")
              .attr("font-size",  function(d) { return log(2,d.links)+12; } )
              .attr("stroke-width", 0)
              .attr("fill", "#444")
              .attr("font-weight", function(d) { return d.links > 5 ? "900" : "100"; })
              .text(function(n) { if (neighboring(d, n)) {return n.name;} });

    force.gravity(.7)
         .distance(150)
         .linkStrength(.8)
         .charge(-9000)
         .friction(.2)
         .start();

    svg.on("click", reset);

    zoom = 1;
    zoomed = d;
    return null;
  }

  function reset(d, i){
    zoom = 0;
    zoomed.fixed = false;
    zoomed = null;
    svg.selectAll(".node").selectAll("text").remove();
    svg.on("click", null);
    resetForce();
  }

  function hoverover(d, i) {
    var metapane = document.getElementById("metapane");
    var this_node = d3.select(this);

    if(!zoom){
      this_node.append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .attr("font-size", 20)
            .attr("stroke-width", 0)
            .attr("fill", "#000")
            .attr("font-weight", "900")
            .text(function(d) { return d.name });
    }

    var link = svg.selectAll(".link");
    var node = svg.selectAll(".node");

    if (link) {
      link.attr("stroke-opacity", function(l) {
        if (l.source === d || l.target === d) {
          return 1.0;
        } else {
          return 0.1;
        }
      }).attr("stroke", function(l) {
        if (l.source === d || l.target === d) {
          return linkcolordark;
        } else {
          return linkcolorlight;
        }
      });
    }

    node.style("opacity", function(n) {
      if (neighboring(d, n)) {
        return 1;
      } else {
        return .2;
      }
    });

    this_node.style("opacity", 1);

    metapane.style.display = "block";
    metapane.innerHTML = "<div class='nodename'>" + d.name + "</div>" +
                         "<div class='nodecountry'>" + d.country + "</div>" +
                         "<div class='nodedollarvalue'>$" + Math.abs(d.dvalue).formatMoney() + "</div>";
  }

  function hoverout(d, i) {
    var metapane = document.getElementById("metapane");
    var this_node = d3.select(this);
    this_node.selectAll("circle")
      .style("stroke-width", "1px")
      .style("opacity", 1);

    var link = svg.selectAll(".link");
    var node = svg.selectAll(".node");

    if(!zoom){
      node.selectAll("text").remove();
    }

    if (link) {
      link.attr("stroke", linkcolorlight)
          .attr("stroke-opacity", 1.0)
          .attr("stroke-width", 1);
    }

    node.style("opacity", 1);

    metapane.innerHTML = "";
    metapane.style.display = "none";
  }

  function setForceDefaults(){
    force
          .gravity(.3)
          .distance(100)
          .linkStrength(.7)
          .charge(-500)
          .friction(.6)
          .size([width, height]);
  }

  function refresh(){

    var link = linkGroup.selectAll(".link")
             .data(links, function(d) { return d.source.key + "-" + d.target.key; });

    link.enter().insert("line")
          .attr("class", "link")
          .attr("stroke", linkcolorlight);

    link.exit().remove();

    var node = nodeGroup.selectAll(".node")
             .data(nodes, function(d) { return d.key;});

    var nodeEnter = node.enter().append("g")
        .attr("class", "node")
        .on("mouseover", hoverover)
        .on("mouseout", hoverout)
        .on("click", click)
        .call(force.drag);

    nodeEnter.append("circle")
      .attr("r", function(d) { return (radius + (d.links * .5)) - .75;})
      .style("fill", function(d) { return fill(d.country_code); })
      .style("stroke", function(d) { return d3.rgb(fill(d.country_code)).darker(); });

    node.exit().remove();

    force.start();
  }

  function resetForce(){
    setForceDefaults();

    if(nodes.length){
      nodes = [];
      links = [];
    }

    json.links.forEach( function(d) { return links.push(d); } );
    json.nodes.forEach( function(d) { return nodes.push(d); } );

    refresh();
  }

  function printCountryKey(){

    var hoverKeyOn = function() {
      return function(){
        var code = this.id;
        var node = svg.selectAll(".node");
        var link = svg.selectAll(".link");

        node.style("opacity", function(n) {
          if (n.country_code == code) {
            return 1;
          } else {
            return .2;
          }
        });
        node.append("text")
          .attr("dx", 12)
          .attr("dy", ".35em")
          .attr("font-size", 12)
          .attr("stroke-width", 0)
          .attr("fill", "#000")
          .attr("font-weight", "900")
          .text(function(n) { if (n.country_code == code) {return n.name;} });

        link.attr("stroke-opacity", 0.2);

      }
    };

    var hoverKeyOff = function() {
      return function(){
        var node = svg.selectAll(".node");
        var link = svg.selectAll(".link");
        node.style("opacity", 1);
        node.selectAll("text").remove();
        link.attr("stroke-opacity", 1);

      }
    };

    var countryKey = [];
    var countryKeyHTML = "";

    json.nodes.forEach(
      function(d){
        if(undefined !== d.country_code){
          return countryKey[d.country_code] = d.country;
        }
      }
    );

    countryKey.forEach(function(d, i){
      return countryKeyHTML = countryKeyHTML +
          "<div class='country' id='"+ i +"'><div class='keyBox' style='background-color: " + fill(i) +
          "'></div><div class='countryName'>" + d + "</div></div>"
    });

    document.getElementById("countryKey").innerHTML = countryKeyHTML;

    var countries = document.getElementsByClassName("country");

    for(var i=0; i<countries.length; i++){
      countries[i].onmouseover = hoverKeyOn();
      countries[i].onmouseout = hoverKeyOff();
    }
  }

});

</script>
<div class="metapane" id="metapane"></div>
<div class="countryKey" id="countryKey"></div>
</body>